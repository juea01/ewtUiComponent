<!DOCTYPE HTML>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>My Listing</title>
	<link rel="stylesheet" href="dijit/themes/claro/claro.css" media="screen">
	<link rel="stylesheet" href="widget/css/MainStyle.css" media="screen">
	<link rel="stylesheet" href="widget/css/Animation.css" media="screen">
	
		<script>dojoConfig = {async: true, parseOnLoad: true}</script>
		<!-- This is for rotating banner -->
		<script src="dojo/dojo.js"></script>
		
	
	<!-- This is for header  --> 
		<script>
			require([
				"dojo/parser",
				"widget/ContainerWidget",
				"dijit/form/Button",
			], function(parser) {
				// Invoke the dojo/parser
				parser.parse();
				var userDetail = sessionStorage.getItem('userDetail');
				
				if(userDetail=== null) {
					StoreState.storePageUrl(window.location.href);
					 window.location.replace('http://localhost:8080/EWTClientUi/Login.html'); 
				}
			});
		</script>
		
		
		
		
	 
	
		
		
		
		
		
	
	
		
		<!-- This is for footer  --> 
		<script>
			require([
				"widget/FooterWidget",
			], function(parser) {
				// Invoke the dojo/parser
				parser.parse();
			});
		</script>
		
	<!-- This is for search box -->
		<script>
			require(["dojo","dojo/dom","dijit/form/Button","dojo/dom","dojo/store/Memory","dijit/form/FilteringSelect","widget/StoreState","dojo/store/JsonRest","dojo/domReady!"],
					function(dojo,dom,Button,dom,Memory,FilteringSelect,StoreState,JsonRest){
				
					var store = new JsonRest({
						target: "http://localhost:8080/EWTRestServices/rest/UtilityServices/productLists"
					});
				 
					var results = store.query({});
						results.then(function (productList) {
						var productStore = new Memory({
							data: productList
						});
						
						var filteringSelect = new  FilteringSelect({
							id: "productSelect",
							name: "Car",
							value: "CA",
							store: productStore,
							searchAttr: "name",
						},"productSelect").startup();
					});
				
					
					
					
							 
					
					var mySearchButton = new Button({
						label: "Search",
						onClick:function(){
							StoreState.storeSearchKeyWord(dijit.byId('productSelect').get('value'));
						window.location.replace('http://localhost:8080/EWTClientUi/Search.html');	
						}
					},"searchButtonNode").startup();
				
					});
		</script>
				
	</head>
	<body class="claro">
	<div id="divContent">
	<!-- This is for header -->
	<div data-dojo-type="widget/ContainerWidget">
		<div class="logo_div">
			<div>EWorldTradeLogo</div>
		</div>
		<div class="search_div">
			<input id="productSelect"/>
			<button id="searchButtonNode" type="button" ><img src="resources/search.png" class="searchButton" height="30" width="50"/></button>
		</div>
		<div class="login_Supplier_Wrapper_div">
		  <div class="listDeal_div">
			<a href="ListDeal.html">List Deal</a>
	      </div>
		  <div class="login_div">
			<a href="Login.html">Login In</a>  | <a href="Registration.html">Join Free</a>
		  </div>
		</div>
		
	</div>
	
<div class="bodyContentWidget">	
<div class="sideBarMenuWidget">
		<a href="MyAccount.html">My Details</a> |
		<a href="MyListing.html">My Listing</a>
</div>
	<div class = "middlealigned">
	<h2> Your Listing</h2> 
<div id="dealContainer"></div>
<div id="paginationWrapper">
 <div id="pagination">
</div>
</div>
 </div>
<script>
	require(["dojo","dojo/on","dojo/dom-construct","dojo/store/JsonRest","dojo/dom","dojo/dom-style","dojo/_base/array", "widget/DealsPageWidget","dijit/form/Button", "dojo/parser","dojo/mouse","dojo/_base/lang","widget/StoreState","dojo/query","dojo/domReady!"], 
			function(dojo,on,domconstruct,JsonRest,dom,domStyle,arrayUtil,DealsPageWidget,button,parser,mouse,lang,StoreState) {						
		
		var userDetail = sessionStorage.getItem('userDetail');
		userDetail = JSON.parse(userDetail);
		var userId = userDetail.userId;
		
		var totalItems = 0;
		var startIndex = 0;
		console.log("Start Index"+ startIndex);
		var store = new JsonRest({
			target: "http://localhost:8080/EWTRestServices/rest/DealServices/deals"
		});
				 
		var results = store.query({
			start: startIndex,
			count: 3,
			userId: userId
		});
		
		results.then(function (data) {
		    // You can access the response data here
		    var dealContainer = dom.byId("dealContainer");			 
			 arrayUtil.forEach(data, function(deal){
				 var widget = new DealsPageWidget(deal).placeAt(dealContainer);
			 })
		    results.total.then(function (total) {
		        // You can access both data and total here
		    	totalItems = total;
		        
		    	// create pagination button dynamically
			    var pagination = dom.byId("pagination");
			    var numPagination = totalItems/3; // we only want 3 items in one page for time being but if we want 9 items it would be *9
			    
			    var backward = domconstruct.create("div",{id: "backward", class:"clickMe", innerHTML: "&lt;&lt; Previous"},pagination);	 
			    //TODO: Currenlty pagination logic is only up to 9 page will need to find out how to do after 9 page.
			    if (numPagination > 9) {
			    	numPagination = 9;
			    	}
			    
				for (var i = 0; i<numPagination; i++) {
					domconstruct.create("div",{id: i+1, class:"clickMe", innerHTML: i+1},pagination);
				}
				var forward = domconstruct.create("div",{id: "forward", class:"clickMe", innerHTML: "Next &gt;&gt;"},pagination);
				
				// creating on click event
				var pageNumber = 1;
				var newNode;
				domStyle.set("backward","opacity",0);
				if(pageNumber >= numPagination) {
	    			domStyle.set("forward","opacity",0);
	    		} else {
	    			domStyle.set("forward","opacity",1);
	    		}	
			    var myObject = {
			    	id: "myObject",
			    	onClick: function(event) {
			    			
			    		if (this.id === "backward") {
			    			if (pageNumber > 1){
			    			pageNumber -= 1;
			    			}
			    		} else if (this.id === "forward") {
			    		 pageNumber += 1;	
			    		} else {
			    			pageNumber = parseInt(this.id);
			    		}
			    		
			    		startIndex = (pageNumber -1) * 3; // we only want 3 items in one page for time being but if we want 9 items it would be *9
			    		getDeals(startIndex);
			    		
			    		if(pageNumber === 1) {
			    			domStyle.set("backward","opacity",0);
			    		} else {
			    			domStyle.set("backward","opacity",1);
			    		}
			    		
			    		if(pageNumber >= numPagination) {
			    			domStyle.set("forward","opacity",0);
			    		} else {
			    			domStyle.set("forward","opacity",1);
			    		}
			    		
						
			    	}
			    };
			 	
			    on(pagination,".clickMe:click",myObject.onClick);
		    });
		}); 
		

	    // Button event to page back;
	    function getDeals(startIndex){
	    	var dealContainer = dom.byId("dealContainer");
	        if(dealContainer){
	          while(dealContainer.firstChild){
	        	  dealContainer.removeChild(dealContainer.firstChild);
	          }
	        }
	      // If we haven't hit the end of the pages yet, allow for requesting another.
	    	store.query({
				start: startIndex,
				count: 3,
				userId: userId
			}).then(function (deals){
				 arrayUtil.forEach(deals, function(deal){
					 var widget = new DealsPageWidget(deal).placeAt(dealContainer);
				 });
			});
	    }
	    
	});
    
	</script>	
	
</div>

	
	<div id="divPush"></div>		
</div>	
<!-- This is for footer -->
	<div data-dojo-type="widget/FooterWidget">
		<div class="footer_group">
			<div><a href="AboutUs.html">About EWorldTrade</a></div>
			<div class="vertical_space">  </div>
			<div>Careers</div>
		</div>
		
		<div class="footer_group">
			<div>Sell on EWorldTrade</div>
			<div class="vertical_space">  </div>
			<div>Own Store on EWorldTrade</div>
		</div>
		
		<div class="footer_group">
			<div>Advertise</div>
			<div class="vertical_space">  </div>
			<div>Become Supplier</div>
		</div>
		
		<div class="footer_group">
			<div>EWorldTrade Policy</div>
			<div class="vertical_space">  </div>
			<div>Return Goods</div>
			<div class="vertical_space">  </div>
			<div>Dispute Center</div>
			<div class="vertical_space">  </div>
			<div>Help</div>
		</div>
	</div>	
		
	</body>
</html>
